<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">

<head>

<meta charset="utf-8" />
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="generator" content="pandoc" />


<meta name="author" content="Day 2 | Network Models and HIV/STI with EpiModel | Harvard 2017" />


<title>Tutorial 2: SIR Epidemic in a Bipartite Network</title>

<script src="site_libs/jquery-1.11.3/jquery.min.js"></script>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link href="site_libs/bootstrap-3.3.5/css/bootstrap.min.css" rel="stylesheet" />
<script src="site_libs/bootstrap-3.3.5/js/bootstrap.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/html5shiv.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/respond.min.js"></script>
<script src="site_libs/jqueryui-1.11.4/jquery-ui.min.js"></script>
<link href="site_libs/tocify-1.9.1/jquery.tocify.css" rel="stylesheet" />
<script src="site_libs/tocify-1.9.1/jquery.tocify.js"></script>
<script src="site_libs/navigation-1.1/tabsets.js"></script>
<link href="site_libs/highlightjs-1.1/default.css" rel="stylesheet" />
<script src="site_libs/highlightjs-1.1/highlight.js"></script>
<link href="site_libs/font-awesome-4.5.0/css/font-awesome.min.css" rel="stylesheet" />

<style type="text/css">code{white-space: pre;}</style>
<style type="text/css">
  pre:not([class]) {
    background-color: white;
  }
</style>
<script type="text/javascript">
if (window.hljs && document.readyState && document.readyState === "complete") {
   window.setTimeout(function() {
      hljs.initHighlighting();
   }, 0);
}
</script>



<style type="text/css">
h1 {
  font-size: 34px;
}
h1.title {
  font-size: 38px;
}
h2 {
  font-size: 30px;
}
h3 {
  font-size: 24px;
}
h4 {
  font-size: 18px;
}
h5 {
  font-size: 16px;
}
h6 {
  font-size: 12px;
}
.table th:not([align]) {
  text-align: left;
}
</style>

<link rel="stylesheet" href="style.css" type="text/css" />

</head>

<body>

<style type = "text/css">
.main-container {
  max-width: 940px;
  margin-left: auto;
  margin-right: auto;
}
code {
  color: inherit;
  background-color: rgba(0, 0, 0, 0.04);
}
img {
  max-width:100%;
  height: auto;
}
.tabbed-pane {
  padding-top: 12px;
}
button.code-folding-btn:focus {
  outline: none;
}
</style>


<style type="text/css">
/* padding for bootstrap navbar */
body {
  padding-top: 51px;
  padding-bottom: 40px;
}
/* offset scroll position for anchor links (for fixed navbar)  */
.section h1 {
  padding-top: 56px;
  margin-top: -56px;
}

.section h2 {
  padding-top: 56px;
  margin-top: -56px;
}
.section h3 {
  padding-top: 56px;
  margin-top: -56px;
}
.section h4 {
  padding-top: 56px;
  margin-top: -56px;
}
.section h5 {
  padding-top: 56px;
  margin-top: -56px;
}
.section h6 {
  padding-top: 56px;
  margin-top: -56px;
}
</style>

<script>
// manage active state of menu based on current page
$(document).ready(function () {
  // active menu anchor
  href = window.location.pathname
  href = href.substr(href.lastIndexOf('/') + 1)
  if (href === "")
    href = "index.html";
  var menuAnchor = $('a[href="' + href + '"]');

  // mark it active
  menuAnchor.parent().addClass('active');

  // if it's got a parent navbar menu mark it active as well
  menuAnchor.closest('li.dropdown').addClass('active');
});
</script>


<div class="container-fluid main-container">

<!-- tabsets -->
<script>
$(document).ready(function () {
  window.buildTabsets("TOC");
});
</script>

<!-- code folding -->




<script>
$(document).ready(function ()  {

    // move toc-ignore selectors from section div to header
    $('div.section.toc-ignore')
        .removeClass('toc-ignore')
        .children('h1,h2,h3,h4,h5').addClass('toc-ignore');

    // establish options
    var options = {
      selectors: "h1,h2,h3",
      theme: "bootstrap3",
      context: '.toc-content',
      hashGenerator: function (text) {
        return text.replace(/[.\\/?&!#<>]/g, '').replace(/\s/g, '_').toLowerCase();
      },
      ignoreSelector: ".toc-ignore",
      scrollTo: 0
    };
    options.showAndHide = true;
    options.smoothScroll = true;

    // tocify
    var toc = $("#TOC").tocify(options).data("toc-tocify");
});
</script>

<style type="text/css">

#TOC {
  margin: 25px 0px 20px 0px;
}
@media (max-width: 768px) {
#TOC {
  position: relative;
  width: 100%;
}
}


.toc-content {
  padding-left: 30px;
  padding-right: 40px;
}

div.main-container {
  max-width: 1200px;
}

div.tocify {
  width: 20%;
  max-width: 260px;
  max-height: 85%;
}

@media (min-width: 768px) and (max-width: 991px) {
  div.tocify {
    width: 25%;
  }
}

@media (max-width: 767px) {
  div.tocify {
    width: 100%;
    max-width: none;
  }
}

.tocify ul, .tocify li {
  line-height: 20px;
}

.tocify-subheader .tocify-item {
  font-size: 0.90em;
  padding-left: 25px;
  text-indent: 0;
}

.tocify .list-group-item {
  border-radius: 0px;
}


</style>

<!-- setup 3col/9col grid for toc_float and main content  -->
<div class="row-fluid">
<div class="col-xs-12 col-sm-4 col-md-3">
<div id="TOC" class="tocify">
</div>
</div>

<div class="toc-content col-xs-12 col-sm-8 col-md-9">




<div class="navbar navbar-inverse  navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="index.html">NME HSPH</a>
    </div>
    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
        <li>
  <a href="index.html">
    <span class="fa fa-home"></span>
     
    Home
  </a>
</li>
      </ul>
      <ul class="nav navbar-nav navbar-right">
        <li>
  <a href="https://epimodel.org/">
    <span class="fa fa-database"></span>
     
    EpiModel
  </a>
</li>
      </ul>
    </div><!--/.nav-collapse -->
  </div><!--/.container -->
</div><!--/.navbar -->

<div class="fluid-row" id="header">



<h1 class="title toc-ignore">Tutorial 2: SIR Epidemic in a Bipartite Network</h1>
<h4 class="author"><em>Day 2 | Network Models and HIV/STI with EpiModel | Harvard 2017</em></h4>

</div>


<p>This tutorial will show how to estimate a dynamic network model for a bipartite network in which the degree distribution varies between modes. A bipartite network structure may be used to represent purely heterogeneous mixing on one attribute as in heterosexual-only models of disease transmission.</p>
<div id="network-model" class="section level1">
<h1>Network Model</h1>
<p>For the network model parameterization, we will review how to fit a bipartite model with a differential degree distribution by mode, similar to the lab work from previous days.</p>
<div id="initialization" class="section level2">
<h2>Initialization</h2>
<p>The number in each mode will be 250 nodes.</p>
<pre class="r"><code>num.m1 &lt;- num.m2 &lt;- 250
nw &lt;- network.initialize(n = num.m1 + num.m2, 
                         bipartite = num.m1, 
                         directed = FALSE)
nw</code></pre>
<pre><code> Network attributes:
  vertices = 500 
  directed = FALSE 
  hyper = FALSE 
  loops = FALSE 
  multiple = FALSE 
  bipartite = 250 
  total edges= 0 
    missing edges= 0 
    non-missing edges= 0 

 Vertex attribute names: 
    vertex.names 

No edge attributes</code></pre>
</div>
<div id="degree-distributions" class="section level2">
<h2>Degree Distributions</h2>
<p>Next, the mode-specific degree distributions are specified as fractions of each mode that have 0, 1, 2, and 3 or more edges at any one time (momentary degree). Within this bipartite framework, the first mode will represent women and the second men. In our hypothetical empirical data, women exhibit less concurrency than men, but also fewer isolates. The following are those fractional distributions.</p>
<pre class="r"><code>deg.dist.m1 &lt;- c(0.40, 0.55, 0.04, 0.01)
deg.dist.m2 &lt;- c(0.54, 0.31, 0.10, 0.05)</code></pre>
<p>In our model, we will use a mean degree of 0.66. How do our degree distributions compare to the distribution expected under a Poisson probability mass function with a rate equal to this the mean degree? The <code>dpois</code> function returns the probability mass for degree 0 through 2 and <code>ppois</code> sums the cumulative mass for degree 3+.</p>
<pre class="r"><code>pois.dists &lt;- c(dpois(0:2, lambda = 0.66), 
                ppois(2, lambda = 0.66, lower.tail = FALSE))</code></pre>
<p>This barplot compares the two observed and the one estimated fractional degree distribution, each adding to 100%. The degree distribution for men more closely matches that of the Poisson distribution, but still has slightly less concurrency than expected.</p>
<pre class="r"><code>par(mar = c(3,3,2,1), mgp = c(2,1,0), mfrow = c(1,1))
barplot(cbind(deg.dist.m1, deg.dist.m2, pois.dists), 
        beside = TRUE, ylim = c(0, 0.6), col = rainbow(4))
legend(&quot;topright&quot;, legend = paste0(&quot;deg&quot;, 3:0), 
       pch = 15, col = rev(rainbow(4)), 
       cex = 0.9, bg = &quot;white&quot;)</code></pre>
<p><img src="d2-tut2_files/figure-html/degDistsPlot-1.png" width="672" /></p>
<p>Within a bipartite network with either a differential mode size or degree distribution, <strong>the overall number of edges “on offer” from each mode must match.</strong> The EpiModel function <code>check_bip_degdist</code> takes as input two mode sizes and two fractional degree distributions and checks whether the total number of implied edges is the same.</p>
<pre class="r"><code>check_bip_degdist(num.m1, num.m2, 
                  deg.dist.m1, deg.dist.m2)</code></pre>
<pre><code>Bipartite Degree Distribution Check
=============================================
        m1.dist   m1.cnt   m2.dist   m2.cnt
Deg0       0.40    100.0      0.54    135.0
Deg1       0.55    137.5      0.31     77.5
Deg2       0.04     10.0      0.10     25.0
Deg3       0.01      2.5      0.05     12.5
Edges      1.00    165.0      1.00    165.0
=============================================
** Edges balanced ** </code></pre>
</div>
<div id="formation-and-dissolution" class="section level2">
<h2>Formation and Dissolution</h2>
<p>Since we have not specified any nodal attributes for the network (other than mode itself), the formation model will only consider aspects of the degree distribution. ERGM model terms are available for mode-specific degree with <code>b1degree</code> and <code>b2degree</code>.</p>
<p>For the target statistics, we specify the number of edges from a mean degree as 0.66 (<code>500/2 * 0.66 = 165</code>). Or we can input the numbers directly from the <code>check_bip_degdist</code> output, where the <code>Edges</code> indicates the edges and the <code>m1.cnt</code> the numbers of mode 1 nodes with degree 0 to 3, and <code>m2.cnt</code> the same for mode 2 nodes. For now we will opt to include statistics for the number of persons in each mode who have degree 0 and degree 1. We’ll explore the reasons for this decision below.</p>
<pre class="r"><code>formation &lt;- ~edges + b1degree(0:1) + b2degree(0:1)
target.stats &lt;- c(165, 100, 137.5, 135, 77.5)</code></pre>
<p>The dissolution model is parameterized the same as the prior example but with a shorter partnership duration.</p>
<pre class="r"><code>coef.diss &lt;- dissolution_coefs(dissolution = ~offset(edges), duration = 10)
coef.diss</code></pre>
<pre><code>Dissolution Coefficients
=======================
Dissolution Model: ~offset(edges)
Target Statistics: 10
Crude Coefficient: 2.197225
Mortality/Exit Rate: 0
Adjusted Coefficient: 2.197225</code></pre>
</div>
<div id="estimation" class="section level2">
<h2>Estimation</h2>
<p>The <code>netest</code> function is used for network model fitting.</p>
<pre class="r"><code>est &lt;- netest(nw, formation, target.stats, coef.diss)</code></pre>
<pre><code>Unable to match target stats. Using MCMLE estimation.</code></pre>
<p>For the dynamic diagnostics, we simulate from the model fit. The simulated degree 0 and degree 1 statistics are right on target.</p>
<pre class="r"><code>dx &lt;- netdx(est, nsims = 5, nsteps = 500,
            nwstats.formula = ~edges + b1degree(0:3) + b2degree(0:3))
dx</code></pre>
<p>To compare simulations against out-of-model predictions, let’s look again at the expected degree 2 and degree 3 for each mode. The simulation means are pretty close to those expectations.</p>
<pre class="r"><code>check_bip_degdist(num.m1, num.m2, 
                  deg.dist.m1, deg.dist.m2)</code></pre>
<pre><code>Bipartite Degree Distribution Check
=============================================
        m1.dist   m1.cnt   m2.dist   m2.cnt
Deg0       0.40    100.0      0.54    135.0
Deg1       0.55    137.5      0.31     77.5
Deg2       0.04     10.0      0.10     25.0
Deg3       0.01      2.5      0.05     12.5
Edges      1.00    165.0      1.00    165.0
=============================================
** Edges balanced ** </code></pre>
<p>Graphically, we can see the subset of statistics are right on target over time.</p>
<pre class="r"><code>plot(dx, stats = c(&quot;edges&quot;, &quot;b1deg1&quot;, &quot;b2deg1&quot;))</code></pre>
<p><img src="d2-tut2_files/figure-html/plotDx-1.png" width="672" /></p>
<p>At the equilibrium state, the average edge duration matches its target.</p>
<pre class="r"><code>plot(dx, type = &quot;duration&quot;)</code></pre>
<p><img src="d2-tut2_files/figure-html/plotDx2-1.png" width="672" /></p>
</div>
</div>
<div id="epidemic-model" class="section level1">
<h1>Epidemic Model</h1>
<p>For the disease simulation, we will be simulating an SIR epidemic in a closed population.</p>
<div id="parameterization" class="section level2">
<h2>Parameterization</h2>
<p>The epidemic model parameters are below. In this tutorial, we will use biological parameters for the infection probability per act and recovery rates as equal to demonstrate the impact of mode-specific degree distributions on outcomes. Note that the mode-specific parameters for the infection probability govern the <em>risk of infection to persons in that mode</em> given contact with persons in the other mode.</p>
<pre class="r"><code>param &lt;- param.net(inf.prob = 0.2, inf.prob.m2 = 0.2,
                   rec.rate = 0.02, rec.rate.m2 = 0.02)</code></pre>
<p>At the outset, 10 people in each mode will be infected. For an SIR epidemic simulation, it is necessary to specify the number recovered in each mode.</p>
<pre class="r"><code>init &lt;- init.net(i.num = 10, i.num.m2 = 10, 
                 r.num = 0, r.num.m2 = 0)</code></pre>
<p>For control settings, we will simulate 5 epidemics over 500 time steps each.</p>
<pre class="r"><code>control &lt;- control.net(type = &quot;SIR&quot;, nsims = 5, nsteps = 500)</code></pre>
</div>
<div id="simulation" class="section level2">
<h2>Simulation</h2>
<p>The model is simulated by inputting the fitted network model, the epidemic parameters, the initial conditions, and control settings.</p>
<pre class="r"><code>sim &lt;- netsim(est, param, init, control)</code></pre>
</div>
<div id="analysis" class="section level2">
<h2>Analysis</h2>
<p>Similar to the first tutorial, plotting the <code>netsim</code> object shows the prevalences for each compartment in the model over time. Interestingly, women (mode 1) have a higher prevalence of disease during the main epidemic period, and more women than men end in the recovered state. Men and women have the same mean degree but men have much higher prevalence of concurrency than women.</p>
<pre class="r"><code>plot(sim)</code></pre>
<p><img src="d2-tut2_files/figure-html/plotSim1-1.png" width="672" /></p>
<p>This more clearly show prevalence and incidence by mode. This provides evidence that conditional on mean degree, concurrency increases the risk of transmission but not acquisition.</p>
<pre class="r"><code>par(mfrow = c(1,2))
plot(sim, y = c(&quot;i.num&quot;, &quot;i.num.m2&quot;), popfrac = TRUE,
     qnts = 0.5, ylim = c(0, 0.4), legend = TRUE)
plot(sim, y = c(&quot;si.flow&quot;, &quot;si.flow.m2&quot;), 
     qnts = 0.5, ylim = c(0, 3), legend = TRUE)</code></pre>
<p><img src="d2-tut2_files/figure-html/plotSim2-1.png" width="672" /></p>
<p>Conceptually, this is explained by comparing two scenarios, one for Sam in which his two partnerships are sequential, and one for Chris in which his two partnerships are concurrent. Both have the same number of partners in 6 months, but if the blue partner is infected with an STI only Chris can transmit back to the red partner. <img src="samandchris.png" alt="Concurrency Example" /></p>
<p>It is possible to plot the color-coded static network at various time points during the simulation, as in the last tutorial. This helps to further show that womens’ (circle) risk is dependent on their male (square) partners’ behaviors.</p>
<pre class="r"><code>par(mfrow = c(1,1), mar = c(0,0,0,0))
plot(sim, type = &quot;network&quot;, col.status = TRUE, at = 50, 
     sims = &quot;mean&quot;, shp.bip = &quot;square&quot;)</code></pre>
<p><img src="d2-tut2_files/figure-html/unnamed-chunk-1-1.png" width="672" /></p>
<p>Extracting the model output to a data frame helps with data analysis outside of the built-in EpiModel functions. Here we show how to calculate the cumulative incidence in each mode over the observed time span.</p>
<pre class="r"><code>df &lt;- as.data.frame(sim)
sum(df$si.flow)</code></pre>
<pre><code>[1] 221</code></pre>
<pre class="r"><code>sum(df$si.flow.m2)</code></pre>
<pre><code>[1] 210.4</code></pre>
<p>With a time step unit of a week, we can calculate the incidence rate per 100 person-years at risk using the following approach. This calculates the time-series of the incidence rates, finds which time step has the maximum incidence, then querying the rate at that time step.</p>
<pre class="r"><code>ir.m1 &lt;- (df$si.flow/df$s.num) * 100 * 52
which.max(ir.m1)</code></pre>
<pre><code>[1] 129</code></pre>
<pre class="r"><code>ir.m1[which.max(ir.m1)]</code></pre>
<pre><code>[1] 199.1489</code></pre>
<p>The transmission matrix in bipartite simulations automatically encodes the IDs of the individual nodes with a “F” or “M” prefix for modes 1 and 2, respectively. With this data, it is possible to see chains of transmission throughout the network.</p>
<pre class="r"><code>tm &lt;- get_transmat(sim)
head(tm, 15)</code></pre>
<pre><code>   at  sus  inf infDur transProb actRate finalProb
1   2 M176  F54     12       0.2       1       0.2
2   2 M218 F168     14       0.2       1       0.2
3   3 M211 F138     43       0.2       1       0.2
4   3  F59 M111     30       0.2       1       0.2
5   3   M5  F36     48       0.2       1       0.2
6   4  F45 M211      1       0.2       1       0.2
7   4  F55 M211      1       0.2       1       0.2
8   4 F186 M176      2       0.2       1       0.2
9   4 M201 F120     14       0.2       1       0.2
10  4 M162 F168     16       0.2       1       0.2
11  4  F22 M246     23       0.2       1       0.2
12  5 F149 M201      1       0.2       1       0.2
13  5 F129 M202     48       0.2       1       0.2
14  5  F83 M201      1       0.2       1       0.2
15  5  M22 F231     14       0.2       1       0.2</code></pre>
<p>This data can be used to show, for example, the percent of infections that occur within the first 10 weeks of infection.</p>
<pre class="r"><code>mean(tm$infDur &lt; 10)</code></pre>
<pre><code>[1] 0.3125</code></pre>
<br>
<hr style="background-color:#909090;height:1px;width:100%">
<p><small> <em>Last updated:</em> 2017-06-26 with EpiModel v1.5.0 </small></p>
</div>
</div>



</div>
</div>

</div>

<script>

// add bootstrap table styles to pandoc tables
function bootstrapStylePandocTables() {
  $('tr.header').parent('thead').parent('table').addClass('table table-condensed');
}
$(document).ready(function () {
  bootstrapStylePandocTables();
});


</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
