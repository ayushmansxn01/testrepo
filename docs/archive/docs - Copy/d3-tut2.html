<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">

<head>

<meta charset="utf-8" />
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="generator" content="pandoc" />


<meta name="author" content="Day 3 | Network Models and HIV/STI with EpiModel | Harvard 2017" />


<title>Tutorial 2: Serosorting</title>

<script src="site_libs/jquery-1.11.3/jquery.min.js"></script>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link href="site_libs/bootstrap-3.3.5/css/bootstrap.min.css" rel="stylesheet" />
<script src="site_libs/bootstrap-3.3.5/js/bootstrap.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/html5shiv.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/respond.min.js"></script>
<script src="site_libs/jqueryui-1.11.4/jquery-ui.min.js"></script>
<link href="site_libs/tocify-1.9.1/jquery.tocify.css" rel="stylesheet" />
<script src="site_libs/tocify-1.9.1/jquery.tocify.js"></script>
<script src="site_libs/navigation-1.1/tabsets.js"></script>
<link href="site_libs/highlightjs-1.1/default.css" rel="stylesheet" />
<script src="site_libs/highlightjs-1.1/highlight.js"></script>
<link href="site_libs/font-awesome-4.5.0/css/font-awesome.min.css" rel="stylesheet" />

<style type="text/css">code{white-space: pre;}</style>
<style type="text/css">
  pre:not([class]) {
    background-color: white;
  }
</style>
<script type="text/javascript">
if (window.hljs && document.readyState && document.readyState === "complete") {
   window.setTimeout(function() {
      hljs.initHighlighting();
   }, 0);
}
</script>



<style type="text/css">
h1 {
  font-size: 34px;
}
h1.title {
  font-size: 38px;
}
h2 {
  font-size: 30px;
}
h3 {
  font-size: 24px;
}
h4 {
  font-size: 18px;
}
h5 {
  font-size: 16px;
}
h6 {
  font-size: 12px;
}
.table th:not([align]) {
  text-align: left;
}
</style>

<link rel="stylesheet" href="style.css" type="text/css" />

</head>

<body>

<style type = "text/css">
.main-container {
  max-width: 940px;
  margin-left: auto;
  margin-right: auto;
}
code {
  color: inherit;
  background-color: rgba(0, 0, 0, 0.04);
}
img {
  max-width:100%;
  height: auto;
}
.tabbed-pane {
  padding-top: 12px;
}
button.code-folding-btn:focus {
  outline: none;
}
</style>


<style type="text/css">
/* padding for bootstrap navbar */
body {
  padding-top: 51px;
  padding-bottom: 40px;
}
/* offset scroll position for anchor links (for fixed navbar)  */
.section h1 {
  padding-top: 56px;
  margin-top: -56px;
}

.section h2 {
  padding-top: 56px;
  margin-top: -56px;
}
.section h3 {
  padding-top: 56px;
  margin-top: -56px;
}
.section h4 {
  padding-top: 56px;
  margin-top: -56px;
}
.section h5 {
  padding-top: 56px;
  margin-top: -56px;
}
.section h6 {
  padding-top: 56px;
  margin-top: -56px;
}
</style>

<script>
// manage active state of menu based on current page
$(document).ready(function () {
  // active menu anchor
  href = window.location.pathname
  href = href.substr(href.lastIndexOf('/') + 1)
  if (href === "")
    href = "index.html";
  var menuAnchor = $('a[href="' + href + '"]');

  // mark it active
  menuAnchor.parent().addClass('active');

  // if it's got a parent navbar menu mark it active as well
  menuAnchor.closest('li.dropdown').addClass('active');
});
</script>


<div class="container-fluid main-container">

<!-- tabsets -->
<script>
$(document).ready(function () {
  window.buildTabsets("TOC");
});
</script>

<!-- code folding -->




<script>
$(document).ready(function ()  {

    // move toc-ignore selectors from section div to header
    $('div.section.toc-ignore')
        .removeClass('toc-ignore')
        .children('h1,h2,h3,h4,h5').addClass('toc-ignore');

    // establish options
    var options = {
      selectors: "h1,h2,h3",
      theme: "bootstrap3",
      context: '.toc-content',
      hashGenerator: function (text) {
        return text.replace(/[.\\/?&!#<>]/g, '').replace(/\s/g, '_').toLowerCase();
      },
      ignoreSelector: ".toc-ignore",
      scrollTo: 0
    };
    options.showAndHide = true;
    options.smoothScroll = true;

    // tocify
    var toc = $("#TOC").tocify(options).data("toc-tocify");
});
</script>

<style type="text/css">

#TOC {
  margin: 25px 0px 20px 0px;
}
@media (max-width: 768px) {
#TOC {
  position: relative;
  width: 100%;
}
}


.toc-content {
  padding-left: 30px;
  padding-right: 40px;
}

div.main-container {
  max-width: 1200px;
}

div.tocify {
  width: 20%;
  max-width: 260px;
  max-height: 85%;
}

@media (min-width: 768px) and (max-width: 991px) {
  div.tocify {
    width: 25%;
  }
}

@media (max-width: 767px) {
  div.tocify {
    width: 100%;
    max-width: none;
  }
}

.tocify ul, .tocify li {
  line-height: 20px;
}

.tocify-subheader .tocify-item {
  font-size: 0.90em;
  padding-left: 25px;
  text-indent: 0;
}

.tocify .list-group-item {
  border-radius: 0px;
}


</style>

<!-- setup 3col/9col grid for toc_float and main content  -->
<div class="row-fluid">
<div class="col-xs-12 col-sm-4 col-md-3">
<div id="TOC" class="tocify">
</div>
</div>

<div class="toc-content col-xs-12 col-sm-8 col-md-9">




<div class="navbar navbar-inverse  navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="index.html">NME HSPH</a>
    </div>
    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
        <li>
  <a href="index.html">
    <span class="fa fa-home"></span>
     
    Home
  </a>
</li>
      </ul>
      <ul class="nav navbar-nav navbar-right">
        <li>
  <a href="https://epimodel.org/">
    <span class="fa fa-database"></span>
     
    EpiModel
  </a>
</li>
      </ul>
    </div><!--/.nav-collapse -->
  </div><!--/.container -->
</div><!--/.navbar -->

<div class="fluid-row" id="header">



<h1 class="title toc-ignore">Tutorial 2: Serosorting</h1>
<h4 class="author"><em>Day 3 | Network Models and HIV/STI with EpiModel | Harvard 2017</em></h4>

</div>


<div id="network-model" class="section level1">
<h1>Network Model</h1>
<p>First, we will set up our network and then calculate our first two sufficient statistics under the assumption that people with infection have a lower mean degree than those without infection. We are not yet considering how they match up.</p>
<pre class="r"><code>n &lt;- 500
nw &lt;- network.initialize(n, directed = FALSE)</code></pre>
<div id="parameterization" class="section level2">
<h2>Parameterization</h2>
<p>The initial prevalence in the network will be 20%. Note that we need to specify a vertex attribute, which must be called <code>status</code>, for this model. This method assigns exactly 100 nodes as infected, but randomly selects which nodes those will be.</p>
<pre class="r"><code>prev &lt;- 0.2
infIds &lt;- sample(1:n, n*prev)
nw &lt;- set.vertex.attribute(nw, &quot;status&quot;, &quot;s&quot;)
nw &lt;- set.vertex.attribute(nw, &quot;status&quot;, &quot;i&quot;, infIds)</code></pre>
<p>For the <code>nodefactor</code> terms that will allow the mean degree of the infecteds to differ from the susceptibles, we need to express them as the number of times an infected or susceptible show up in an edge. This is just the the group mean degree times the group size.</p>
<pre class="r"><code>mean.deg.inf &lt;- 0.3
inedges.inf &lt;- mean.deg.inf * n * prev

mean.deg.sus &lt;- 0.8
inedges.sus &lt;- mean.deg.sus * n * (1 - prev)</code></pre>
<p>The number of edges is the sum of these two nodefactor statistics divided by 2.</p>
<pre class="r"><code>edges &lt;- (inedges.inf + inedges.sus)/2</code></pre>
<p><strong>Nodematch Question:</strong> what is the number of node-matched edges under the null assumption that there is no matching on status but different activity levels for the two groups?</p>
<p><em>The exact solution:</em> from population genetics, the Hardy-Weinberg formula. This just fills out a two-by-two table that contains the probabilities of a negative-negative, positive-positive, and negative-positive pair. The proportion of partnerships that are matched on status is the diagonal of the table, which is the sum of the negative-negative and positive-positive probabilities.</p>
<pre class="r"><code>p &lt;- inedges.sus/(edges*2)
q &lt;- 1 - p
nn &lt;- p^2
np &lt;- 2*p*q
pp &lt;- q^2
round(nn + pp, 3)</code></pre>
<pre><code>[1] 0.843</code></pre>
<p><em>A simulation-based solution:</em> we estimate an ergm in which there is no nodematch term but otherwise the same model, then simulate from that fitted model to monitor the expected number of matched edges. The proportion of matched edges is that number over the total edges.</p>
<pre class="r"><code>fit &lt;- ergm(nw ~ edges + nodefactor(&quot;status&quot;),
            target.stats = c(edges, inedges.sus))</code></pre>
<pre><code>Evaluating log-likelihood at the estimate. </code></pre>
<pre class="r"><code>sim &lt;- simulate(fit, statsonly = TRUE, nsim = 1e5,
                monitor = ~nodematch(&quot;status&quot;))
mn &lt;- colMeans(sim)
mn</code></pre>
<pre><code>              edges nodefactor.status.s    nodematch.status 
           175.0177            320.0647            147.5934 </code></pre>
<pre class="r"><code>round(as.numeric(mn[3]/mn[1]), 3)</code></pre>
<pre><code>[1] 0.843</code></pre>
<p>Let us now imagine that there <em>are</em> in fact more within-group ties than expected by chance:</p>
<pre class="r"><code>nmatch &lt;- edges * 0.91</code></pre>
</div>
<div id="estimation" class="section level2">
<h2>Estimation</h2>
<p>This tutorial will compare two models to assess the impact of serosorting on disease transmission:</p>
<ul>
<li><em>Model 1</em> features two forms of sero-adaptive behavior: different levels of activity by disease status, and matching on status.</li>
<li><em>Model 2</em> has neither, so is just a Bernoulli model with same mean degree as Model 1.</li>
</ul>
<div id="model-1" class="section level3">
<h3>Model 1</h3>
<p>The network model with serosorting will include terms for both the number of times susceptible persons show up in an edge, as well as the number of node-matched edges overall. It is not necessary to specify the nodefactor term for the susceptibles because that is a function of total edges and the nodefactor term for the infecteds (the base level is always the first in alphabetical or numerical order, so “i” for our status variable level in this case). The average partnership duration in both models will be 50 time steps.</p>
<pre class="r"><code>formation &lt;- ~edges + nodefactor(&quot;status&quot;) + nodematch(&quot;status&quot;)
target.stats &lt;- c(edges, inedges.sus, nmatch)

coef.diss &lt;- dissolution_coefs(dissolution = ~offset(edges), 50)

est &lt;- netest(nw, formation, target.stats, coef.diss)</code></pre>
<pre><code>Unable to match target stats. Using MCMLE estimation.</code></pre>
<p>We run the network diagnostics on the model. Everything appears fine.</p>
<pre class="r"><code>dx &lt;- netdx(est, nsims = 5, nsteps = 500,
            nwstats.formula = ~edges + 
                               meandeg + 
                               nodefactor(&quot;status&quot;, base = 0) + 
                               nodematch(&quot;status&quot;), verbose = FALSE)
dx</code></pre>
<pre><code>EpiModel Network Diagnostics
=======================
Diagnostic Method: Dynamic
Simulations: 5
Time Steps per Sim: 500

Formation Diagnostics
----------------------- 
                    Target Sim Mean Pct Diff Sim SD
edges               175.00  176.287    0.007 13.125
meandeg                 NA    0.705       NA  0.052
nodefactor.status.i     NA   31.582       NA  6.419
nodefactor.status.s 320.00  320.992    0.003 25.361
nodematch.status    159.25  159.514    0.002 12.716

Dissolution Diagnostics
----------------------- 
               Target Sim Mean Pct Diff Sim SD
Edge Duration   50.00   44.374   -0.113 43.151
Pct Edges Diss   0.02    0.020    0.007  0.011</code></pre>
<pre class="r"><code>plot(dx, plots.joined = FALSE)</code></pre>
<p><img src="d3-tut2_files/figure-html/dx1-1.png" width="672" /></p>
<pre class="r"><code>plot(dx, type = &quot;duration&quot;)</code></pre>
<p><img src="d3-tut2_files/figure-html/dx1-2.png" width="672" /></p>
</div>
<div id="model-2" class="section level3">
<h3>Model 2</h3>
<p>The second model will include only an edges term, so no serosorting behavior but same amount of activity among nodes. After estimation, the diagnostics here look fine too.</p>
<pre class="r"><code>nw &lt;- network.initialize(n, directed = FALSE)
est2 &lt;- netest(nw, formation = ~edges, target.stats = edges, coef.diss)

dx2 &lt;- netdx(est2, nsims = 5, nsteps = 1000,
             nwstats.formula = ~edges + meandeg)
dx2
plot(dx2, plots.joined = FALSE)</code></pre>
<p><img src="d3-tut2_files/figure-html/mod2Est-1.png" width="672" /></p>
</div>
</div>
</div>
<div id="epidemic-model" class="section level1">
<h1>Epidemic Model</h1>
<p>For the epidemic model, we will simulate an SI disease, with our two counterfactual network models. The first model will use the serosorting network model, and the second will be the random Bernoulli model.</p>
<div id="model-1-1" class="section level2">
<h2>Model 1</h2>
<p>The model will only include one named parameter, for the transmission probability per contact.</p>
<pre class="r"><code>param &lt;- param.net(inf.prob = 0.03)</code></pre>
<p>The initial conditions are now passed through to the epidemic model not through <code>init.net</code> as with previous examples, but through the <code>netest</code> object that contains the original starting network with the vertex attributes for status. However, because <code>netsim</code> will still be expecting an initial conditions list, we need to create an empty one as a placeholder.</p>
<pre class="r"><code>init &lt;- init.net()</code></pre>
<p>For the control settings, we monitor the same network statistics as we did in the network diagnostics above, and do not save the network objects out to save disk space.</p>
<pre class="r"><code>control &lt;- control.net(type = &quot;SI&quot;, nsteps = 500, nsims = 5, 
                       nwstats.formula = ~edges + 
                                          meandeg + 
                                          nodefactor(&quot;status&quot;, base = 0) + 
                                          nodematch(&quot;status&quot;),
                       save.network = FALSE)</code></pre>
<p>Here, we run the model. We will return to it to compare output later.</p>
<pre class="r"><code>sim &lt;- netsim(est, param, init, control)</code></pre>
</div>
<div id="model-2-1" class="section level2">
<h2>Model 2</h2>
<p>The second model includes the same epidemic parameters as Model 1, but the initial conditions now must be specified because the network object in that second network model did not contain the status attribute. We use the <code>status.rand</code> argument to make sure that exactly 100 nodes are infected in this model too.</p>
<pre class="r"><code>param &lt;- param.net(inf.prob = 0.03)
init &lt;- init.net(i.num = n*prev, status.rand = FALSE)
control &lt;- control.net(type = &quot;SI&quot;, nsteps = 500, nsims = 5, 
                       nwstats.formula = ~edges + meandeg,
                       save.network = FALSE)
sim2 &lt;- netsim(est2, param, init, control)</code></pre>
</div>
<div id="results" class="section level2">
<h2>Results</h2>
<p>In reverse of our usual approach, we’ll look at the epidemic results first and then the network diagnostics, because the network statistics will be a function of the epidemiology.</p>
<p>Here we see that the serosorting model grows much less quickly than the random model. The reasons are that nodes lower their mean degree upon infection, therefore have fewer partners over time, and also tend to preferentially partner with other infecteds.</p>
<pre class="r"><code>par(mfrow = c(1,2))
plot(sim, main = &quot;Serosorting&quot;)
plot(sim2, main = &quot;No Serosorting&quot;)</code></pre>
<p><img src="d3-tut2_files/figure-html/plot1-1.png" width="672" /></p>
<p>Another method to show the relative difference is to plot the two epidemic trajectories together. This requires a custom legend.</p>
<pre class="r"><code>par(mfrow = c(1,1))
plot(sim, y = &quot;i.num&quot;, popfrac = TRUE, sim.lines = FALSE, qnts = 1)
plot(sim2, y = &quot;i.num&quot;, popfrac = TRUE, sim.lines = FALSE, qnts = 1, 
     mean.col = &quot;firebrick&quot;, qnts.col = &quot;firebrick&quot;, add = TRUE)
legend(&quot;topleft&quot;, c(&quot;Serosort&quot;, &quot;Non-Serosort&quot;), lty = 1, lwd = 3,
       col = c(&quot;steelblue&quot;, &quot;firebrick&quot;), cex = 0.9, bty = &quot;n&quot;)</code></pre>
<p><img src="d3-tut2_files/figure-html/plot2-1.png" width="672" /></p>
<p>Now, here are the network statistics that we monitored in Model 1. In contrast to our previous tutorials, where we expected stochastic variation around the targets to be preserved over time, here every network statistic varies.</p>
<pre class="r"><code>plot(sim, type = &quot;formation&quot;, plots.joined = FALSE)</code></pre>
<p><img src="d3-tut2_files/figure-html/plot3-1.png" width="672" /></p>
<p>Notice first that the <code>nodefactor</code> statistics are moving in opposite directions: as the prevalence of disease increases from 20% to approximately 50% at time 500, the number of infected nodes in an edge increases. The quantity preserved is <em>not</em> the number of infected nodes in an edge that we set as a target (30 nodes); rather, it is the log-odds of an infected node in an edge conditional on other terms in the model.</p>
<pre class="r"><code>plot(sim, type = &quot;formation&quot;, stats = c(&quot;nodefactor.status.s&quot;, 
                                        &quot;nodefactor.status.i&quot;))</code></pre>
<p><img src="d3-tut2_files/figure-html/plot4-1.png" width="672" /></p>
<p>Second, note that the total edges and node-matched edges decline over time. This plot shows those two statistics from one simulation only for clarity. Ordinarily the mean degree is preserved even in a population with drastically changing size, due to the network density correction that automatically occurs in <code>netsim</code>.</p>
<pre class="r"><code>plot(sim, type = &quot;formation&quot;, 
     stats = c(&quot;edges&quot;, &quot;nodematch.status&quot;), 
     sims = 1, sim.lwd = 2)</code></pre>
<p><img src="d3-tut2_files/figure-html/plot5-1.png" width="672" /></p>
<p>But in this case, the edges and mean degree are shrinking because the number of nodes in the network with the same status is steadily increasing, which draws the node match statistic lower since there are fewer susceptible-susceptible pairs available. Since the edges is a constant multiple of node-matched edges, they move together.</p>
<p>After looking at so many models where the target statistics were preserved throughout the simulation, this may seem like odd or undesirable behavior here. If it does, think about the main assumption we began with: men who are infected tend to have lower rates of partnering than men who are not infected. Perhaps this is because they are ill, or because they are trying to protect others. If this is the case, then what should we expect to happen to the overall rate of partnering as the proportion of men who are infected increases? Presumably it should go down, which is precisely what we see.</p>
<p>This behavior does mean that it can be difficut to tease apart the different contributions of serosorting to the disease dynamics that we see. How much of serosorting’s effect on lowering transmission came from the rate of overall partner reductions for infected men, and how much came from the homophily effect where infected men partner with each other relatively more? Although we included both in our model (through the nodefactor and nodematch terms, respectively), one could easily consider intermediate models that only included one term or the other, and then compare the results of each to the two models we already considered. We would then have a sense of the individual effects of each of these behavioral components, as well as their combined effect. Is the latter additive, less than additive, or more than additive (i.e. synergistic?)</p>
<br>
<hr style="background-color:#909090;height:1px;width:100%">
<p><small> <em>Last updated:</em> 2017-06-28 with EpiModel v1.5.0 </small></p>
</div>
</div>



</div>
</div>

</div>

<script>

// add bootstrap table styles to pandoc tables
function bootstrapStylePandocTables() {
  $('tr.header').parent('thead').parent('table').addClass('table table-condensed');
}
$(document).ready(function () {
  bootstrapStylePandocTables();
});


</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
